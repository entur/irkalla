apiVersion: v1
data:
  application.properties: |-
    spring.profiles.active=gcs-blobstore
    server.port={{ .Values.service.http.internalPort }}

    # Chouette
    chouette.url={{ .Values.configMap.chouetteUrl }}
    chouette.sync.stop.place.full.cron=0 30 23 ? * SAT *
    chouette.sync.stop.place.cron=0 0/5 * * * ?
    chouette.sync.stop.place.autoStartup=true

    # Tiamat
    tiamat.url={{ .Values.configMap.tiamatUrl }}

    #OAuth2 Resource Server
    spring.security.oauth2.resourceserver.jwt.issuer-uri={{ .Values.configMap.auth0.ror.url }}
    irkalla.oauth2.resourceserver.auth0.ror.jwt.audience={{ .Values.configMap.auth0.ror.audience }}
    irkalla.oauth2.resourceserver.auth0.ror.claim.namespace=https://ror.entur.io/

    # Blobstore
    blobstore.gcs.project.id={{ .Values.configMap.blobstoreProjectId }}
    blobstore.gcs.credential.path=/etc/irkalla-service-account/credentials.json
    blobstore.gcs.container.name={{ .Values.configMap.blobstoreName }}

    # PubSub
    irkalla.pubsub.project.id={{ .Values.configMap.pubsubProjectId }}
    spring.cloud.gcp.pubsub.project-id=${irkalla.pubsub.project.id}
    camel.component.google-pubsub.service-account-key=file:/etc/irkalla-service-account/credentials.json


    # Spring Actuator
    management.server.port={{ .Values.service.http.managementPort }}
    management.endpoints.enabled-by-default=false
    management.endpoint.info.enabled=true
    management.endpoint.health.enabled=true
    management.endpoint.health.group.readiness.include=readinessState
    management.health.pubsub.enabled=false
    management.endpoint.prometheus.enabled=true
    management.endpoints.web.exposure.include=info,health,prometheus

    spring.jackson.serialization.write-dates-as-timestamps=false
    # disable local redelivery to force Camel routes to be retried entirely.
    # this prevents a local retry from sending inconsistent requests to chouette
    irkalla.camel.redelivery.max=0

    # Kafka
    irkalla.kafka.topic.event={{ .Values.configMap.kafka.topicUpdatedStopPlaces }}
    camel.component.kafka.brokers={{ .Values.configMap.kafka.brokers }}
    camel.component.kafka.security-protocol={{ .Values.configMap.kafka.secProtocol }}
    camel.component.kafka.sasl-mechanism={{ .Values.configMap.kafka.saslMechanism }}
    camel.component.kafka.sasl-jaas-config=org.apache.kafka.common.security.scram.ScramLoginModule required username="${irkalla.kafka.sasl.username}" password="${irkalla.kafka.sasl.password}";
    camel.component.kafka.schema-registry-u-r-l={{ .Values.configMap.kafka.registry }}

    # Camel
    camel.springboot.name=Irkalla
    camel.dataformat.json-jackson.module-refs=jacksonJavaTimeModule
    camel.servlet.mapping.context-path=/services/*
    camel.cluster.kubernetes.enabled=true
    camel.cluster.kubernetes.cluster-labels[app]=irkalla
    camel.cluster.kubernetes.config-map-name=irkalla-leaders




kind: ConfigMap
metadata:
  name: {{ template "irkalla.name" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "common.labels" . | indent 4 }}
